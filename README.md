# Проектная работа 3 спринта

## Дано

Небольшая компания, организующая удалённое управление отоплением в доме, получила заказ на создание экосистемы умных поселков на территории нескольких регионов страны. Необходимые датчики и реле установлены лишь в половине домов, желающих подключиться к целевой экосистеме. 

Состояние компании в настоящий момент не позволяет в полной мере реализовать новые бизнес-цели: расширять функционал и масштабироваться. Для этого требуется пересмотр и оптимизация всей экосистемы.

## Текущее решение компании
- Нынешнее положение компании позволяет только управлять отоплением в доме и проверять температуру.
- Каждая установка сопровождается выездом специалиста по подключению системы отопления в доме к текущей версии системы.
- Архитектура компании представляет из себя монолит на Java с СУБД Postgres. Всё синхронно. Никаких асинхронных вызовов, микросервисов и реактивного взаимодействия в системе нет. Всё управление идёт от сервера к датчику. Данные о температуре также получаются через запрос от сервера к датчику.
- Самостоятельно подключить свой датчик к системе пользователь не может.

## Целевая экосистема, которую необходимо создать
- Экосистема доступна пользователю в режиме самообслуживания по модели SaaS.
- Система позволяет управлять отоплением, включать и выключать свет, запирать и отпирать автоматические ворота, удаленно наблюдать за домом и будущее неуточненное поведение.
- Пользователь самостоятельно выбирает необходимые ему модули умного дома (устройства), сам их подключает, настраивает сценарии работы и просматривает телеметрию.
- Компания не занимается производством устройств, но поддерживает подключение к экосистеме устройств партнеров по стандартным протоколам.
- Веб-разработка передана на аутсорс и не входит в требования данной работы.

## Требования к экосистеме
- Модули управления приборами и сами приборы (устройства) должны быть максимально готовы к использованию и продаваться в отдельных комплектах для удобной покупки и подключения.
- Устройства должны быть доступны через интернет (для удаленного наблюдения и доступа), и предполагается, что пользователь будет иметь интернет-канал, к которому их можно подключить.
- Покупатели могут программировать систему для управления различными модулями в соответствии со своими потребностями.

## Цели бизнеса
**Промежуточное состояние (через пару месяцев)**
- Описана AsIs и ToBe архитектура решения. Создан план по переходу к целевой системе.
- MVP с разделёнными микросервисами для управления отоплением, освещением, наблюдением, воротами.

**Финальное состояние (через год)**
- Настроенные CI/CD пайплайны для автоматизации сборки и деплоя платформы экосистемы.
- Полностью развернутая экосистема умного дома с модульной структурой.
- Платформа экосистемы готова к подключению до 100 экопоселков по 200 домов по пять устройств в каждом.
- Пользователи могут самостоятельно подключать новые модули, управлять ими через интернет и настраивать автоматические сценарии работы устройств.

В этой проектной работе всего вас ждёт три задания. **Обязательная часть включает первое задание и часть второго.** Вам предстоит спроектировать архитектуру и реализовать MVP новой экосистемы, которая будет:

- Модульной и масштабируемой, чтобы легко добавлять новые функции.
- Ориентированной на самообслуживание, чтобы пользователи могли всё делать сами.
- Основанной на микросервисах, чтобы обеспечить гибкость и отказоустойчивость.

# Задание 1: Анализ и проектирование

>Первое задание состоит из четырёх частей, в которых вы проанализируете текущее монолитное приложение, выделите микросервисы и спроектируете взаимодействие между ними, визуализируете архитектуру с помощью инструмента С4, а затем разработаете ER-диаграмму. 

## Подзадание 1.1: Анализ и планирование
>Прежде чем проектировать новую систему, необходимо досконально разобраться с тем, что у нас есть. Вам нужно изучить текущее монолитное приложение, понять его сильные и слабые стороны, а также проанализировать, как принципы Domain-Driven Design (DDD) могут быть применены для построения новой архитектуры.

# Решение 

Функциональность монолитного приложения:
- Управление отоплением:
  - Пользователи могут удалённо включать/выключать отопление в своих домах.(`/api/heating/{id}/turn-on`, `/api/heating/{id}/turn-off`) 
  - Пользователи могут устанавливать желаемую температуру. (`/api/heating/{id}/set-temperature`)
  - Пользователи могут просматривать информацию о системе. (`/api/heating/{id}`)
  - Пользователи могут обновлять информацию о системе. (`post /api/heating/{id}`)
  - Система автоматически поддерживает заданную температуру, регулируя подачу тепла. (в данном проекте не реализовано)

- Мониторинг температуры:
  - Система получает данные о температуре с датчиков, установленных в домах. (номинально есть поход в бд, но откуда берутся данные в бд неизвестно) 
  - Пользователи могут просматривать текущую температуру в своих домах через веб-интерфейс.(`/api/heating/{id}/current-temperature`)

Aнализ архитектуры монолитного приложения:
- Язык программирования: Java
- База данных: PostgreSQL
- Архитектура: Монолитная, все компоненты системы (обработка запросов, бизнес-логика, работа с данными) находятся в рамках одного приложения.
- Взаимодействие: Синхронное, запросы обрабатываются последовательно.
- Масштабируемость: Ограничена, так как монолит сложно масштабировать по частям.
- Развертывание: Требует остановки всего приложения.

Определение доменов и границы контекстов  
- **Домен**: Управление устройствами(в монолите представлено только отопление)
  - **Поддомен**: Отключение/Включение устройства
  - **Поддомен**: Конфигурция устройства
- **Домен**: Телемитрия(температура)
  - **Поддомен**: Сбор данных о температуры с датчиков
  - **Поддомен**: Просмотр информации о температуре в доме

Визуализация контекста системы
[С4 диаграмма](./puml/context.puml)

## Подзадание 1.2: Архитектура микросервисов
>Вы провели анализ текущего монолитного приложения, определили его функциональные блоки и выделили основные домены. Теперь ваша задача — спроектировать высокоуровневую архитектуру новой экосистемы, основанную на микросервисах. Для этого вам нужно определить ключевые микросервисы, спроектировать их взаимодействие с учетом использования API Gateway и Kafka  (опционально, взаимодействие между сервисами может быть реализовано напрямую), а также визуализировать полученную архитектуру с помощью диаграмм C4.

1. Декомпозиция на микросервисы.
> Основываясь на выделенных доменах и границах контекстов (подзадание 1.1) и бизнес-целях, разбейте систему на новые микросервисы, учитывая наилучшие практики архитектуры микросервисов и паттерны проектирования.

Основные микросервсы 
- API Gateway (Единая точка входа для пользовательского потока)
- Smart Home Manager (Сервис хранит информацию о домах пользователя)
- Device Manager (Сервис содержит информацию об устройствах и управляет их конфигурацией)
- User Manager (Сервис хранит пользовательские данные и в системе умного дома)
- Telemetry (Сервис содержит исторические данные различного рода метрик с датчиков устройств)
- Device Adapter (Сервис-адаптер над сторонним API устройств и датчиков, отвечающий за интеграцию различных устройств)

2. Визуализация архитектуры:
     
- [C4 — Уровень контейнеров (Containers)](./puml/containers.puml)
- [C4 — Уровень компонента Device Manager (Components)](./puml/device-manager-component.puml)
- [C4 — Уровень компонента Telemetry (Components)](./puml/telemetry-component.puml)

## Подзадание 1.3: ER-диаграмма
>К началу этого подзадания вы определили ключевые микросервисы и спроектировали их взаимодействие с использованием API Gateway и Kafka. А ещё визуализировали полученную архитектуру с помощью диаграмм C4, что позволило вам получить чёткое представление о структуре и взаимодействиях в системе. 
>В этом задании вам предстоит глубже погрузиться в структуру данных будущей экосистемы. Необходимо определить ключевые сущности (такие как «Устройство», «Модуль», «Пользователь», «Телеметрия») и смоделировать их взаимосвязи, чтобы создать логическую модель базы данных.

[ER диаграмма](./puml/er-models.puml)

## Подзадание 1.4: Создание и документирование API
>После успешной разработки ER-диаграммы вы получили чёткое представление о структуре данных будущей экосистемы. Теперь настало время перейти к следующему этапу — созданию и документированию API. 
Микросервисы должны уметь «общаться» друг с другом. Ваша задача — спроектировать API (интерфейс программного приложения) для взаимодействия между двумя ключевыми микросервисами, которые вы определили ранее, например «Управление устройствами» и «Телеметрия». Вам нужно определить необходимые эндпойнты, методы запросов, форматы данных и описать контракты взаимодействия, чтобы микросервисы могли эффективно обмениваться информацией.


Для сервисов описаны контракты в виде прото моделей и сгенерированы файлы для SwaggerUI:
- [device-manager.proto](./microsirvices/device-manager/proto/device-manager/device-manager.proto)
- [device-manager.swagger.json](./microsirvices/device-manager/swagger-ui/device-manager/device-manager.swagger.json)
- [telemetry.proto](./microsirvices/telemetry/proto/telemetry/telemetry.proto)
- [telemetry.swagger.json](./microsirvices/telemetry/swagger-ui/telemetry/telemetry.swagger.json)

При желание можно поднять сервисы локально для ознокомления с контрактом через SwaggerUI `http://localhost:9091/docs`

```bash
➜  microsirvices git:(sprint_3) ✗ cd device-manager
➜  device-manager git:(sprint_3) ✗ make local-run
2024/10/11 22:25:54 grpc gateway server listening at 0.0.0.0:9091
2024/10/11 22:25:54 grpc server listening at 0.0.0.0:9090
### ---
➜  microsirvices git:(sprint_3) ✗ cd telemetry
➜  telemetry git:(sprint_3) ✗ make local-run
2024/10/11 22:25:14 grpc gateway server listening at 0.0.0.0:9091
2024/10/11 22:25:14 grpc server listening at 0.0.0.0:9090
```

Для определения сообщений в Kafka сформерован фаил:
- [kafka.yaml](./microsirvices/kafka.yaml)

При желании ознакомится с файлом можно с помощью https://studio.asyncapi.com

# Задание 2: Разработка MVP (Опционально)
## Подзадание 2.1: Новые микросервисы и интеграция с монолитом

Частично реализован сервис device-manager, сделан мок сервис telemetry. В связи с тем, что заболел и на работе высокая загруженность данную часть не успел доделать. Однако данные пункт сделали опциональным(https://app.pachca.com/chats/12178363?message=351304817)

